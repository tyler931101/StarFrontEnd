<div class="container">
    <div class="form-container">
        <!-- Success/Error Messages -->
        <div *ngIf="successMessage" class="success-message">
            ✓ {{ successMessage }}
        </div>

        <div *ngIf="errorMessage" class="error-message">
            ⚠ {{ errorMessage }}
        </div>

        <!-- Avatar Section -->
        <div class="avatar-upload-section">
            <div class="avatar-preview" [class.has-error]="imageError" (click)="triggerFileInput()">
                <img [src]="profileImage" alt="Profile Avatar" class="profile-image" />
                <div class="avatar-overlay">
                    <i class=""></i>
                    <span>Change Photo</span>
                </div>
                <div *ngIf="isUploading" class="avatar-loading">
                    <i class="fas fa-spinner"></i>
                </div>
            </div>

            <input #fileInput type="file" accept="image/*" (change)="onFileChange($event)" hidden />

            <div *ngIf="profileImage !== 'assets/default-avatar.png'" class="avatar-controls">
                <button type="button" class="avatar-remove" (click)="removeAvatar()" [disabled]="isUploading">
                    <i class="fas fa-trash"></i> Delete
                </button>
            </div>

            <div *ngIf="imageError" class="error-message">
                {{ imageError }}
            </div>
        </div>

        <!-- Tabs Navigation -->
        <div class="tabs">
            <button class="tab-btn" [class.active]="activeTab === 'profile'" (click)="setActiveTab('profile')">
                Profile Settings
            </button>
            <button class="tab-btn" [class.active]="activeTab === 'password'" (click)="setActiveTab('password')">
                Change Password
            </button>
        </div>

        <!-- Profile Tab -->
        <div *ngIf="activeTab === 'profile'" class="tab-content">
            <ng-form #profileForm="ngForm" (ngSubmit)="saveChanges(profileForm)" novalidate>
                <div class="form-group">
                    <label for="username">Username</label>
                    <input type="text" id="username" name="username" [(ngModel)]="profileData['username']" required
                        minlength="3" maxlength="50" #username="ngModel"
                        [class.invalid]="username.invalid && username.touched" aria-describedby="usernameHelp" />
                    <div id="usernameHelp" class="error-message" *ngIf="username.invalid && username.touched">
                        <small *ngIf="username.errors?.['required']">Username is required.</small>
                        <small *ngIf="username.errors?.['minlength']">At least 3 characters.</small>
                        <small *ngIf="username.errors?.['maxlength']">Maximum 50 characters.</small>
                    </div>
                </div>

                <div class="form-group">
                    <label for="email">Email</label>
                    <input type="email" id="email" name="email" [(ngModel)]="profileData['email']" required minlength="3"
                        maxlength="50" #email="ngModel" [class.invalid]="email.invalid && email.touched"
                        pattern="[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,}$" aria-describedby="emailHelp" />
                    <div id="emailHelp" class="error-message" *ngIf="email.invalid && email.touched">
                        <small *ngIf="email.errors?.['required']">Email is required.</small>
                        <small *ngIf="email.errors?.['pattern']">Please enter a valid email.</small>
                        <small *ngIf="email.errors?.['minlength']">At least 3 characters.</small>
                        <small *ngIf="email.errors?.['maxlength']">Maximum 50 characters.</small>
                    </div>
                </div>

                <div class="form-group">
                    <label for="phone">Phone Number</label>
                    <input type="tel" id="phone" name="phone" [(ngModel)]="profileData['phone']" pattern="[0-9+\-\s\(\)]*"
                        #phone="ngModel" [class.invalid]="phone.invalid && phone.touched" aria-describedby="phoneHelp" />
                    <div id="phoneHelp" class="error-message" *ngIf="phone.invalid && phone.touched">
                        <small *ngIf="phone.errors?.['pattern']">Enter a valid phone number.</small>
                    </div>
                </div>

                <div class="form-group">
                    <label>Role:</label>
                    <input type="text" [value]="userRole" disabled class="disabled">
                </div>
                
                <div class="form-group">
                    <label>Account Created:</label>
                    <input type="text" [value]="formatDate(accountCreated)" disabled class="disabled">
                </div>
                
                <div class="form-group">
                    <label>Email Verified:</label>
                    <input type="text" [value]="isVerified ? 'Yes' : 'No'" disabled class="disabled">
                    </div>

                <div class="form-actions">
                    <button type="submit" class="btn-submit" (click)="saveChanges(profileForm)" [disabled]="isSubmitting || profileForm.invalid">
                        {{ isSubmitting ? 'Saving...' : 'Save Changes' }}
                    </button>
                    <button type="button" class="btn-reset" (click)="resetProfile()" [disabled]="isSubmitting">
                        Reset
                    </button>
                </div>
            </ng-form>
        </div>

        <!-- Password Change Tab -->
        <div *ngIf="activeTab === 'password'" class="tab-content">
            <ng-form #passwordForm="ngForm" (ngSubmit)="changePassword($event, passwordForm)" novalidate>
                <div *ngIf="passwordError" class="error-message">
                    {{ passwordError }}
                </div>
        
                <div class="form-group">
                    <label for="currentPassword">Current Password</label>
                    <input type="password" id="currentPassword" name="currentPassword"
                        [(ngModel)]="passwordData.currentPassword" required #currentPassword="ngModel"
                        [class.invalid]="(currentPassword.invalid && currentPassword.touched) || passwordError" />
                    <div class="error-message" *ngIf="currentPassword.invalid && currentPassword.touched">
                        <small *ngIf="currentPassword.errors?.['required']">Current password is required.</small>
                    </div>
                </div>
        
                <div class="form-group">
                    <label for="newPassword">New Password</label>
                    <input type="password" id="newPassword" name="newPassword" [(ngModel)]="passwordData.newPassword" required
                        minlength="8" pattern="^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&])[A-Za-z\d@$!%*?&]{8,}$"
                        #newPassword="ngModel" [class.invalid]="newPassword.invalid && newPassword.touched" />
                    <div class="error-message" *ngIf="newPassword.invalid && newPassword.touched">
                        <small *ngIf="newPassword.errors?.['required']">New password is required.</small>
                        <small *ngIf="newPassword.errors?.['minlength']">At least 8 characters.</small>
                        <small *ngIf="newPassword.errors?.['pattern']">
                            Must contain at least one uppercase letter, one lowercase letter, one number, and one special
                            character.
                        </small>
                    </div>
                </div>
        
                <div class="form-group">
                    <label for="confirmPassword">Confirm New Password</label>
                    <input type="password" id="confirmPassword" name="confirmPassword"
                        [(ngModel)]="passwordData.confirmPassword" required #confirmPassword="ngModel"
                        [class.invalid]="(confirmPassword.invalid && confirmPassword.touched) || (passwordData.newPassword && passwordData.confirmPassword && passwordData.newPassword !== passwordData.confirmPassword)" />
                    <div class="error-message" *ngIf="confirmPassword.invalid && confirmPassword.touched">
                        <small *ngIf="confirmPassword.errors?.['required']">Please confirm your new password.</small>
                    </div>
                    <div class="error-message"
                        *ngIf="passwordData.newPassword && passwordData.confirmPassword && passwordData.newPassword !== passwordData.confirmPassword">
                        <small>Passwords do not match.</small>
                    </div>
                </div>
        
                <div class="form-actions">
                    <button type="submit" class="btn-submit"
                        [disabled]="isChangingPassword || passwordForm.invalid || (passwordData.newPassword !== passwordData.confirmPassword)">
                        {{ isChangingPassword ? 'Changing...' : 'Change Password' }}
                    </button>
                    <button type="button" class="btn-reset" (click)="resetPasswordForm()" [disabled]="isChangingPassword">
                        Clear
                    </button>
                </div>
            </ng-form>
        </div>
    </div>
    </div>