<div class="container">
    <h1>Ticket Management</h1>
    <div class="main-content">
        <div class="toolbar">
            <div class="filters">
                <div class="filter-search"><app-search [placeholder]="'Search tickets'" [searchTerm]="searchTerm"
                        (search)="onSearch($event)"></app-search></div>
                
                <select class="filter-select" [(ngModel)]="selectedAssignee" (change)="applyFilter()">
                    <option value="">All Assignees</option>
                    <option *ngFor="let u of assignees" [value]="u.id">{{ u.username }}</option>
                </select>
                <select class="filter-select" [(ngModel)]="selectedStatus" (change)="applyFilter()">
                    <option value="">All Statuses</option>
                    <option value="todo">To Do</option>
                    <option value="in_progress">In Progress</option>
                    <option value="resolved">Resolved</option>
                    <option value="testing">Testing</option>
                    <option value="closed">Closed</option>
                </select>
            </div>
                
            <div><button class="btn-submit" (click)="openCreate()"> <i class="fas fa-plus"></i>Create Ticket</button></div>
        </div>
        
        <div class="board">
            <div class="column">
                <div class="column-header">To Do</div>
                <div cdkDropList [id]="'todoList'" [cdkDropListData]="filteredTodo"
                    [cdkDropListConnectedTo]="['inProgressList','resolvedList','testingList', 'closedList']" class="list"
                    (cdkDropListDropped)="drop($event)">
                    <div class="card todo" *ngFor="let t of filteredTodo" cdkDrag [cdkDragData]="t">
                        <div class="card-header">
                            <div class="card-title">{{ t.title }}</div>
                            <span class="priority" [class.high]="t.priority==='high'" [class.medium]="t.priority==='medium'"
                                [class.low]="t.priority==='low'" [class.urgent]="t.priority==='urgent'">{{ t.priority }}</span>
                        </div>
                        <div class="card-body">
                            <p class="card-description">{{ t.description || 'No description' }}</p>
                        </div>
                        <div class="card-footer">
                            <span class="due-date"><i class="fas fa-calendar-alt"></i><p>{{ t.dueDate.slice(0, 10) }}</p></span>
                            <span class="assignee"><i class="fas fa-user"></i><p>{{ t.assignee?.username || '' }}</p></span>
                            <span class="ms-auto">
                                <i class="edit-ticket fas fa-pencil" (click)="openEdit(t)"></i>
                                <i class="delete-ticket fas fa-trash" (click)="openDelete(t)"></i>
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        
            <div class="column">
                <div class="column-header">In Progress</div>
                <div cdkDropList [id]="'inProgressList'" [cdkDropListData]="filteredInProgress"
                    [cdkDropListConnectedTo]="['todoList','resolvedList','testingList','closedList']" class="list"
                    (cdkDropListDropped)="drop($event)">
                    <div class="card inProgress" *ngFor="let t of filteredInProgress" cdkDrag [cdkDragData]="t">
                        <div class="card-header">
                            <div class="card-title">{{ t.title }}</div>
                            <span class="priority" [class.high]="t.priority==='high'" [class.medium]="t.priority==='medium'"
                                [class.low]="t.priority==='low'" [class.urgent]="t.priority==='urgent'">{{ t.priority }}</span>
                        </div>
                        <div class="card-body">
                            <p class="card-description">{{ t.description || 'No description' }}</p>
                        </div>
                        <div class="card-footer">
                            <span class="due-date"><i class="fas fa-calendar-alt"></i>
                                <p>{{ t.dueDate.slice(0, 10) }}</p>
                            </span>
                            <span class="assignee"><i class="fas fa-user"></i>
                                <p>{{ t.assignee?.username || '' }}</p>
                            </span>
                            <span class="ms-auto">
                                <i class="edit-ticket fas fa-pencil" (click)="openEdit(t)"></i>
                                <i class="delete-ticket fas fa-trash" (click)="openDelete(t)"></i>
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        
            <div class="column">
                <div class="column-header">Resolved</div>
                <div cdkDropList [id]="'resolvedList'" [cdkDropListData]="filteredResolved"
                    [cdkDropListConnectedTo]="['todoList','inProgressList','testingList','closedList']" class="list"
                    (cdkDropListDropped)="drop($event)">
                    <div class="card resolved" *ngFor="let t of filteredResolved" cdkDrag [cdkDragData]="t">
                        <div class="card-header">
                            <div class="card-title">{{ t.title }}</div>
                            <span class="priority" [class.high]="t.priority==='high'" [class.medium]="t.priority==='medium'"
                                [class.low]="t.priority==='low'" [class.urgent]="t.priority==='urgent'">{{ t.priority }}</span>
                        </div>
                        <div class="card-body">
                            <p class="card-description">{{ t.description || 'No description' }}</p>
                        </div>
                        <div class="card-footer">
                            <span class="due-date"><i class="fas fa-calendar-alt"></i>
                                <p>{{ t.dueDate.slice(0, 10) }}</p>
                            </span>
                            <span class="assignee"><i class="fas fa-user"></i>
                                <p>{{ t.assignee?.username || '' }}</p>
                            </span>
                            <span class="ms-auto">
                                <i class="edit-ticket fas fa-pencil" (click)="openEdit(t)"></i>
                                <i class="delete-ticket fas fa-trash" (click)="openDelete(t)"></i>
                            </span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="column">
                <div class="column-header">Testing</div>
                <div cdkDropList [id]="'testingList'" [cdkDropListData]="filteredTesting"
                    [cdkDropListConnectedTo]="['todoList','inProgressList','resolvedList','closedList']" class="list"
                    (cdkDropListDropped)="drop($event)">
                    <div class="card testing" *ngFor="let t of filteredTesting" cdkDrag [cdkDragData]="t">
                        <div class="card-header">
                            <div class="card-title">{{ t.title }}</div>
                            <span class="priority" [class.high]="t.priority==='high'" [class.medium]="t.priority==='medium'"
                                [class.low]="t.priority==='low'" [class.urgent]="t.priority==='urgent'">{{ t.priority }}</span>
                        </div>
                        <div class="card-body">
                            <p class="card-description">{{ t.description || 'No description' }}</p>
                        </div>
                        <div class="card-footer">
                            <span class="due-date"><i class="fas fa-calendar-alt"></i>
                                <p>{{ t.dueDate.slice(0, 10) }}</p>
                            </span>
                            <span class="assignee"><i class="fas fa-user"></i>
                                <p>{{ t.assignee?.username || '' }}</p>
                            </span>
                            <span class="ms-auto">
                                <i class="edit-ticket fas fa-pencil" (click)="openEdit(t)"></i>
                                <i class="delete-ticket fas fa-trash" (click)="openDelete(t)"></i>
                            </span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="column">
                <div class="column-header">Closed</div>
                <div cdkDropList [id]="'closedList'" [cdkDropListData]="filteredClosed"
                    [cdkDropListConnectedTo]="['todoList','inProgressList','resolvedList','testingList']" class="list"
                    (cdkDropListDropped)="drop($event)">
                    <div class="card closed" *ngFor="let t of filteredClosed" cdkDrag [cdkDragData]="t">
                        <div class="card-header">
                            <div class="card-title">{{ t.title }}</div>
                            <span class="priority" [class.high]="t.priority==='high'" [class.medium]="t.priority==='medium'"
                                [class.low]="t.priority==='low'" [class.urgent]="t.priority==='urgent'">{{ t.priority }}</span>
                        </div>
                        <div class="card-body">
                            <p class="card-description">{{ t.description || 'No description' }}</p>
                        </div>
                        <div class="card-footer">
                            <span class="due-date"><i class="fas fa-calendar-alt"></i>
                                <p>{{ t.dueDate.slice(0, 10) }}</p>
                            </span>
                            <span class="assignee"><i class="fas fa-user"></i>
                                <p>{{ t.assignee?.username || '' }}</p>
                            </span>
                            <span class="ms-auto">
                                <i class="edit-ticket fas fa-pencil" (click)="openEdit(t)"></i>
                                <i class="delete-ticket fas fa-trash" (click)="openDelete(t)"></i>
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <app-modal [title]="'Edit Ticket'" [size]="'md'" [confirmText]="'Save'" [cancelText]="'Cancel'"
            [isVisible]="isEditModalVisible" (confirm)="saveEdit()" (closeModal)="closeEditModal()">
            <div class="form-group">
                <label>Title</label>
                <input type="text" class="form-control" [(ngModel)]="editTitle">
                <div class="error-message" *ngIf="editAttempted && !editTitle">
                    <small>Title is required.</small>
                </div>
            </div>
            <div class="form-group">
                <label>Description</label>
                <textarea class="form-control" rows="3" [(ngModel)]="editDescription"></textarea>
                <div class="error-message" *ngIf="editAttempted && !editDescription">
                    <small>Description is required.</small>
                </div>
            </div>
            <div class="form-group">
                <label>Priority</label>
                <select [(ngModel)]="editPriority">
                    <option value="high">High</option>
                    <option value="medium">Medium</option>
                    <option value="low">Low</option>
                    <option value="urgent">Urgent</option>
                </select>
                <div class="error-message" *ngIf="editAttempted && !editPriority">
                    <small>Priority is required.</small>
                </div>
            </div>
            <div class="form-group">
                <label>Assignee</label>
                <select [(ngModel)]="editAssignedTo">
                    <option *ngFor="let u of assignees" [value]="u.id">{{ u.username }}</option>
                </select>
                <div class="error-message" *ngIf="editAttempted && !editAssignedTo">
                    <small>Assignee is required.</small>
                </div>
            </div>
            <div class="form-group">
                <label>Due Date</label>
                <input type="date" [(ngModel)]="editDueDate" />
                <div class="error-message" *ngIf="editAttempted && !editDueDate">
                    <small>Due Date is required.</small>
                </div>
            </div>
        </app-modal>
        
        <app-modal [title]="'Create Ticket'" [size]="'md'" [confirmText]="'Create'" [cancelText]="'Cancel'"
            [isVisible]="isCreateModalVisible" (confirm)="saveCreate()" (closeModal)="closeCreateModal()">
            <div class="form-group">
                <label>Title</label>
                <input type="text" [(ngModel)]="editTitle" />
                <div class="error-message" *ngIf="createAttempted && !editTitle">
                    <small>Title is required.</small>
                </div>
            </div>
            <div class="form-group">
                <label>Description</label>
                <textarea class="form-control" rows="3" [(ngModel)]="editDescription"></textarea>
                <div class="error-message" *ngIf="createAttempted && !editDescription">
                    <small>Description is required.</small>
                </div>
            </div>
            <div class="form-group">
                <label>Priority</label>
                <select [(ngModel)]="editPriority">
                    <option value="high">High</option>
                    <option value="medium">Medium</option>
                    <option value="low">Low</option>
                    <option value="urgent">Urgent</option>
                </select>
                <div class="error-message" *ngIf="createAttempted && !editPriority">
                    <small>Priority is required.</small>
                </div>
            </div>
            <div class="form-group">
                <label>Assignee</label>
                <select [(ngModel)]="editAssignedTo">
                    <option *ngFor="let u of assignees" [value]="u.id">{{ u.username }}</option>
                </select>
                <div class="error-message" *ngIf="createAttempted && !editAssignedTo">
                    <small>Assignee is required.</small>
                </div>
            </div>
            <div class="form-group">
                <label>Due Date</label>
                <input type="date" [(ngModel)]="editDueDate" />
                <div class="error-message" *ngIf="createAttempted && !editDueDate">
                    <small>Due Date is required.</small>
                </div>
            </div>
        </app-modal>
        
        <app-modal [title]="'Delete Ticket'" [size]="'sm'" [confirmText]="'Delete'" [cancelText]="'Cancel'"
            [isVisible]="isDeleteModalVisible" (confirm)="confirmDelete()" (closeModal)="closeDeleteModal()">
            <div class="text-center">
                <p>Are you sure you want to delete this ticket?</p>
                <p class="text-muted">This action cannot be undone.</p>
            </div>
        </app-modal>
    </div>
</div>