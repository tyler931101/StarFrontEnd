<div class="container">
    <h1>Ticket Management</h1>
    <div class="main-content">
        <div class="toolbar">
            <div class="filters">
                <div class="filter-search"><app-search [placeholder]="'Search tickets'" [searchTerm]="searchTerm"
                        (search)="onSearch($event)"></app-search></div>
                
                <select class="filter-select" [(ngModel)]="selectedAssignee" (change)="applyFilter()">
                    <option value="">All Assignees</option>
                    <option *ngFor="let u of users" [value]="u">{{ u }}</option>
                </select>
                <select class="filter-select" [(ngModel)]="selectedStatus" (change)="applyFilter()">
                    <option value="">All Statuses</option>
                    <option value="todo">To Do</option>
                    <option value="in_progress">In Progress</option>
                    <option value="resolved">Resolved</option>
                    <option value="testing">Testing</option>
                    <option value="done">Done</option>
                </select>
            </div>
                
            <div><button class="btn-submit" (click)="openCreate()"> <i class="fas fa-plus"></i>Create Ticket</button></div>
        </div>
        
        <div class="board">
            <div class="column">
                <div class="column-header">To Do</div>
                <div cdkDropList [id]="'todoList'" [cdkDropListData]="filteredTodo"
                    [cdkDropListConnectedTo]="['inProgressList','resolvedList','testingList','doneList']" class="list"
                    (cdkDropListDropped)="drop($event)">
                    <div class="card" *ngFor="let t of filteredTodo" cdkDrag [cdkDragData]="t">
                        <div class="card-title">{{ t.title }}</div>
                        <div class="card-meta">
                            <span class="badge">{{ t.id }}</span>
                            <span class="priority" [class.high]="t.priority==='high'" [class.medium]="t.priority==='medium'"
                                [class.low]="t.priority==='low'">{{ t.priority }}</span>
                            <span class="assignee">{{ t.assignedTo }}</span>
                            <span class="ms-auto">
                                <button class="btn btn-sm btn-outline-primary" (click)="openEdit(t)">Edit</button>
                                <button class="btn btn-sm btn-outline-danger" (click)="openDelete(t)">Delete</button>
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        
            <div class="column">
                <div class="column-header">In Progress</div>
                <div cdkDropList [id]="'inProgressList'" [cdkDropListData]="filteredInProgress"
                    [cdkDropListConnectedTo]="['todoList','resolvedList','testingList','doneList']" class="list"
                    (cdkDropListDropped)="drop($event)">
                    <div class="card" *ngFor="let t of filteredInProgress" cdkDrag [cdkDragData]="t">
                        <div class="card-title">{{ t.title }}</div>
                        <div class="card-meta">
                            <span class="badge">{{ t.id }}</span>
                            <span class="priority" [class.high]="t.priority==='high'" [class.medium]="t.priority==='medium'"
                                [class.low]="t.priority==='low'">{{ t.priority }}</span>
                            <span class="assignee">{{ t.assignedTo }}</span>
                            <span class="ms-auto">
                                <button class="btn btn-sm btn-outline-primary" (click)="openEdit(t)">Edit</button>
                                <button class="btn btn-sm btn-outline-danger" (click)="openDelete(t)">Delete</button>
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        
            <div class="column">
                <div class="column-header">Resolved</div>
                <div cdkDropList [id]="'resolvedList'" [cdkDropListData]="filteredResolved"
                    [cdkDropListConnectedTo]="['todoList','inProgressList','testingList','doneList']" class="list"
                    (cdkDropListDropped)="drop($event)">
                    <div class="card" *ngFor="let t of filteredResolved" cdkDrag [cdkDragData]="t">
                        <div class="card-title">{{ t.title }}</div>
                        <div class="card-meta">
                            <span class="badge">{{ t.id }}</span>
                            <span class="priority" [class.high]="t.priority==='high'" [class.medium]="t.priority==='medium'"
                                [class.low]="t.priority==='low'">{{ t.priority }}</span>
                            <span class="assignee">{{ t.assignedTo }}</span>
                            <span class="ms-auto">
                                <button class="btn btn-sm btn-outline-primary" (click)="openEdit(t)">Edit</button>
                                <button class="btn btn-sm btn-outline-danger" (click)="openDelete(t)">Delete</button>
                            </span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="column">
                <div class="column-header">Testing</div>
                <div cdkDropList [id]="'testingList'" [cdkDropListData]="filteredTesting"
                    [cdkDropListConnectedTo]="['todoList','inProgressList','resolvedList','doneList']" class="list"
                    (cdkDropListDropped)="drop($event)">
                    <div class="card" *ngFor="let t of filteredTesting" cdkDrag [cdkDragData]="t">
                        <div class="card-title">{{ t.title }}</div>
                        <div class="card-meta">
                            <span class="badge">{{ t.id }}</span>
                            <span class="priority" [class.high]="t.priority==='high'" [class.medium]="t.priority==='medium'"
                                [class.low]="t.priority==='low'">{{ t.priority }}</span>
                            <span class="assignee">{{ t.assignedTo }}</span>
                            <span class="ms-auto">
                                <button class="btn btn-sm btn-outline-primary" (click)="openEdit(t)">Edit</button>
                                <button class="btn btn-sm btn-outline-danger" (click)="openDelete(t)">Delete</button>
                            </span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="column">
                <div class="column-header">Closed</div>
                <div cdkDropList [id]="'doneList'" [cdkDropListData]="filteredDone"
                    [cdkDropListConnectedTo]="['todoList','inProgressList','resolvedList','testingList']" class="list"
                    (cdkDropListDropped)="drop($event)">
                    <div class="card" *ngFor="let t of filteredDone" cdkDrag [cdkDragData]="t">
                        <div class="card-title">{{ t.title }}</div>
                        <div class="card-meta">
                            <span class="badge">{{ t.id }}</span>
                            <span class="priority" [class.high]="t.priority==='high'" [class.medium]="t.priority==='medium'"
                                [class.low]="t.priority==='low'">{{ t.priority }}</span>
                            <span class="assignee">{{ t.assignedTo }}</span>
                            <span class="ms-auto">
                                <button class="btn btn-sm btn-outline-primary" (click)="openEdit(t)">Edit</button>
                                <button class="btn btn-sm btn-outline-danger" (click)="openDelete(t)">Delete</button>
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <app-modal [title]="'Edit Ticket'" [size]="'md'" [confirmText]="'Save'" [cancelText]="'Cancel'"
            [isVisible]="isEditModalVisible" (confirm)="saveEdit()" (closeModal)="closeEditModal()">
            <div class="form-group">
                <label>Title</label>
                <input type="text" class="form-control" [(ngModel)]="editTitle">
            </div>
            <div class="form-group">
                <label>Description</label>
                <textarea class="form-control" rows="3" [(ngModel)]="editDescription"></textarea>
            </div>
            <div class="form-group">
                <label>Priority</label>
                <select [(ngModel)]="editPriority">
                    <option value="high">High</option>
                    <option value="medium">Medium</option>
                    <option value="low">Low</option>
                </select>
            </div>
            <div class="form-group">
                <label>Assignee</label>
                <select [(ngModel)]="editAssignedToId">
                    <option *ngFor="let u of assignees" [value]="u.id">{{ u.username }}</option>
                </select>
            </div>
            <div class="form-group">
                <label>Status</label>
                <select [(ngModel)]="editStatus">
                    <option value="todo">To Do</option>
                    <option value="in_progress">In Progress</option>
                    <option value="resolved">Resolved</option>
                    <option value="testing">Testing</option>
                    <option value="done">Done</option>
                </select>
            </div>
        </app-modal>
        
        <app-modal [title]="'Create Ticket'" [size]="'md'" [confirmText]="'Create'" [cancelText]="'Cancel'"
            [isVisible]="isCreateModalVisible" (confirm)="saveCreate()" (closeModal)="closeCreateModal()">
            <div class="form-group">
                <label>Title</label>
                <input type="text" [(ngModel)]="editTitle">
            </div>
            <div class="form-group">
                <label>Description</label>
                <textarea class="form-control" rows="3" [(ngModel)]="editDescription"></textarea>
            </div>
            <div class="form-group">
                <label>Priority</label>
                <select [(ngModel)]="editPriority">
                    <option value="high">High</option>
                    <option value="medium">Medium</option>
                    <option value="low">Low</option>
                </select>
            </div>
            <div class="form-group">
                <label>Assignee</label>
                <select [(ngModel)]="editAssignedToId">
                    <option *ngFor="let u of assignees" [value]="u.id">{{ u.username }}</option>
                </select>
            </div>
        </app-modal>
        
        <app-confirm *ngIf="isDeleteModalVisible" [title]="'Delete Ticket'"
            [message]="'Are you sure you want to delete ' + (selectedTicket?.title || '') + '?'"
            [details]="'This action cannot be undone.'" type="warning" confirmText="Delete" cancelText="Cancel"
            confirmButtonClass="danger" [isVisible]="isDeleteModalVisible" (confirm)="confirmDelete()"
            (closeModal)="closeDeleteModal()"></app-confirm>
    </div>
</div>
