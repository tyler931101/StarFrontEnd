<div class="container">
    <h1>User Management</h1>
    <div class="main-content">
        <!-- Filters and Search -->
        <div class="toolbar">
            <div class="filters">
                <app-search [placeholder]="'Search by username, email, or phone'" [debounceTime]="300"
                    (search)="onSearch($event)"></app-search>
                <select class="filter-select" [value]="statusFilter"
                    (change)="onStatusFilterChange($event)">
                    <option value="">All</option>
                    <option value="active">Active</option>
                    <option value="inactive">Inactive</option>
                    <option value="pending">Pending</option>
                </select>
            </div>
        </div>
        
        <!-- Users Table -->
        <div class="card">
            <div class="card-body">
                <div class="table">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>No</th>
                                <th>Avatar</th>
                                <th class="sortable" (click)="changeSort('username')">
                                    Username <i [class]="getSortIcon('username')"></i>
                                </th>
                                <th class="sortable" (click)="changeSort('email')">
                                    Email <i [class]="getSortIcon('email')"></i>
                                </th>
                                <th class="sortable" (click)="changeSort('phone')">
                                    Phone <i [class]="getSortIcon('phone')"></i>
                                </th>
                                <th class="sortable" (click)="changeSort('status')">
                                    Status <i [class]="getSortIcon('status')"></i>
                                </th>
                                <th class="sortable" (click)="changeSort('role')">
                                    Role <i [class]="getSortIcon('role')"></i>
                                </th>
                                <th class="sortable" (click)="changeSort('createdAt')">
                                    Created <i [class]="getSortIcon('createdAt')"></i>
                                </th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr *ngIf="isLoading">
                                <td colspan="8" class="text-center py-5">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                </td>
                            </tr>
        
                            <tr *ngFor="let user of users; let i = index">
                                <td>{{ (currentPage - 1) * pageSize + i + 1 }}</td>
                                <td>
                                    <div class="user-avatar-container">
                                        <img class="user-avatar" [src]="getAvatar(user.id)" alt="" />
                                    </div>
                                </td>
                                <td>{{ user.username }}</td>
                                <td>{{ user.email }}</td>
                                <td>{{ user.phone }}</td>
                                <td>
                                    <span class="badge" [ngClass]="getStatusBadgeClass(user.status)">
                                        {{ user.status | titlecase }}
                                    </span>
                                </td>
                                <td>
                                    <span class="badge" [ngClass]="getRoleBadgeClass(user.role)">
                                        {{ user.role | titlecase }}
                                    </span>
                                </td>
                                <td>{{ user.createdAt | date:'shortDate' }}</td>
                                <td>
                                    <div class="btn-group btn-group-sm" role="group">
                                        <i class="edit-user fas fa-pencil" (click)="openEditModal(user)"></i>
                                        <i class="delete-user fas fa-trash" (click)="openDeleteModal(user)"></i>
                                    </div>
                                </td>
                            </tr>
        
                            <tr *ngIf="!isLoading && users.length === 0">
                                <td colspan="8" class="text-center py-5 text-muted">
                                    No users found
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
        
                <div class="card-footer">
                    <!-- Pagination -->
                    <app-pagination *ngIf="totalUsers > 0" [currentPage]="currentPage" [totalItems]="totalUsers" [pageSize]="pageSize"
                        [totalPages]="totalPages" (pageChange)="onPageChange($event)"
                        (pageSizeChange)="onPageSizeChange($event)"></app-pagination>
                </div>
            </div>
        </div>
        
        <!-- Edit User Modal -->
        <app-modal *ngIf="isEditModalVisible" [title]="'Edit User: ' + (selectedUser?.username || '')" size="md"
            [isVisible]="isEditModalVisible" [confirmDisabled]="userForm.invalid || isLoading" confirmText="Save Changes"
            (confirm)="saveUser()" (closeModal)="closeEditModal()">
            <form [formGroup]="userForm">
                <div class="form-group">
                    <label>Username</label>
                    <input type="text" class="form-control" formControlName="username">
                    <div *ngIf="userForm.get('username')?.invalid && userForm.get('username')?.touched" class="error-message">
                        Username is required and must be at least 3 characters
                    </div>
                </div>
        
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" class="form-control" formControlName="email">
                    <div *ngIf="userForm.get('email')?.invalid && userForm.get('email')?.touched" class="error-message">
                        Valid email is required
                    </div>
                </div>
        
                <div class="form-group">
                    <label>Phone</label>
                    <input type="tel" class="form-control" formControlName="phone">
                    <div *ngIf="userForm.get('phone')?.invalid && userForm.get('phone')?.touched" class="error-message">
                        <small *ngIf="userForm.get('phone')?.errors?.['required']">Phone number is required</small>
                        <small *ngIf="userForm.get('phone')?.errors?.['pattern']">Please enter a valid phone number (e.g. +1234567890)</small>
                    </div>
                </div>
        
                <div class="form-group">
                    <label>Status</label>
                    <select formControlName="status">
                        <option value="active">Active</option>
                        <option value="inactive">Inactive</option>
                        <option value="pending">Pending</option>
                    </select>
                </div>
    
                <div class="form-group">
                    <label>Role</label>
                    <select formControlName="role">
                        <option value="user">User</option>
                        <option value="editor">Editor</option>
                        <option value="admin">Admin</option>
                    </select>
                </div>
            </form>
        </app-modal>
        
        <!-- Delete Confirmation Modal -->
        <app-confirm *ngIf="isDeleteModalVisible" [title]="'Delete User'"
            [message]="'Are you sure you want to delete user ' + (selectedUser?.username || '') + '?'"
            [details]="'This action cannot be undone.'" type="warning" confirmText="Delete" cancelText="Cancel"
            confirmButtonClass="danger" [isVisible]="isDeleteModalVisible" (confirm)="confirmDelete()"
            (closeModal)="closeDeleteModal()"></app-confirm>
    </div>
</div>
